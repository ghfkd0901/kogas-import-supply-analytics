"""
# ğŸ“Œ ë°ì´í„° ì¶œì²˜ ë° ì‚¬ìš© ë°©ë²•

## 1. í•œêµ­ê°€ìŠ¤ê³µì‚¬_í•œêµ­ì˜ ëŒ€ë¥™ë³„ ì²œì—°ê°€ìŠ¤ ìˆ˜ì…í˜„í™©

- ì›ë³¸ ë°ì´í„°: ê³µê³µë°ì´í„°í¬í„¸(data.go.kr)
- ë°ì´í„°ì…‹ ì´ë¦„: **í•œêµ­ê°€ìŠ¤ê³µì‚¬_í•œêµ­ì˜ ëŒ€ë¥™ë³„ ì²œì—°ê°€ìŠ¤ ìˆ˜ì…í˜„í™©**
- ë§í¬: https://www.data.go.kr/data/15088508/fileData.do

### ì´ ì½”ë“œì—ì„œì˜ í™œìš© ë°©ì‹

- ì›ë³¸ CSV íŒŒì¼ ê²½ë¡œ  
  `D:\Project\í•œêµ­ê°€ìŠ¤ê³µì‚¬ì›”ë³„ì‹œë„ë³„ë„ì‹œê°€ìŠ¤íŒë§¤í˜„í™©\data\í•œêµ­ê°€ìŠ¤ê³µì‚¬_í•œêµ­ì˜ ëŒ€ë¥™ë³„ ì²œì—°ê°€ìŠ¤ ìˆ˜ì… í˜„í™©_20240630.csv`
- ì£¼ìš” ì›ë³¸ ì»¬ëŸ¼ ì˜ˆì‹œ
  - `ì—°ì›”ì¼`
  - `ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)_ì•„ì‹œì•„`, `ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)_ì•„ì‹œì•„`, `ì¤‘ëŸ‰(í†¤)_ì•„ì‹œì•„`
  - `ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)_ë¶ì•„ë©”ë¦¬ì¹´`, `ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)_ë¶ì•„ë©”ë¦¬ì¹´`, `ì¤‘ëŸ‰(í†¤)_ë¶ì•„ë©”ë¦¬ì¹´`
  - `...`, `ê¸°íƒ€` ë“± ëŒ€ë¥™ë³„ ë‹¨ìœ„ê°€ê²©/ê¸ˆì•¡/ì¤‘ëŸ‰ ì»¬ëŸ¼

### ì „ì²˜ë¦¬/ê°€ê³µ ë¡œì§ ê°œìš”

1. ì¸ì½”ë”©ì„ `utf-8` â†’ ì‹¤íŒ¨ ì‹œ `cp949` ìˆœì„œë¡œ ì‹œë„í•˜ì—¬ CSV ì½ê¸°
2. `ì¤‘ëŸ‰(í†¤)ê¸°íƒ€` ì»¬ëŸ¼ëª…ì´ ìˆì„ ê²½ìš° `ì¤‘ëŸ‰(í†¤)_ê¸°íƒ€`ë¡œ ì •ì •
3. `_í•©ê³„`ë¡œ ëë‚˜ëŠ” **í•©ê³„ ì—´ì€ ëª¨ë‘ ì‚­ì œ**
   - ì˜ˆ: `ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)_í•©ê³„`, `ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)_í•©ê³„`, `ì¤‘ëŸ‰(í†¤)_í•©ê³„`
4. ì„¸ ì¢…ë¥˜ì˜ ì§€í‘œë¥¼ ê°ê° long í¬ë§·ìœ¼ë¡œ ë³€í™˜(melt)
   - ë‹¨ìœ„ê°€ê²©: `ì—°ì›”ì¼, ìˆ˜ì…ì§€ì—­, ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)`
   - ê¸ˆì•¡: `ì—°ì›”ì¼, ìˆ˜ì…ì§€ì—­, ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)`
   - ì¤‘ëŸ‰: `ì—°ì›”ì¼, ìˆ˜ì…ì§€ì—­, ì¤‘ëŸ‰(í†¤)`
5. ìœ„ ì„¸ DataFrameì„ `ì—°ì›”ì¼ + ìˆ˜ì…ì§€ì—­` ê¸°ì¤€ìœ¼ë¡œ ë³‘í•©í•˜ì—¬ ìµœì¢… long í¬ë§· ìƒì„±
   - ìµœì¢… ì»¬ëŸ¼: `ì—°ì›”ì¼, ìˆ˜ì…ì§€ì—­, ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬), ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬), ì¤‘ëŸ‰(í†¤)`
6. `ì—°ì›”ì¼`ì„ `datetime`ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì‹œê³„ì—´ ê·¸ë˜í”„ì— ì‚¬ìš©

### ì‹œê°í™”(ì´ í˜ì´ì§€ì—ì„œ ë³´ì—¬ì£¼ëŠ” ë‚´ìš©)

1. **1ë²ˆ ê·¸ë˜í”„ â€“ ë‹¨ìœ„ê¸ˆì•¡(ë‹¨ìœ„ê°€ê²©) êº¾ì€ì„  ê·¸ë˜í”„**
   - y: `ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)`  
   - x: `ì—°ì›”ì¼`  
   - ìƒ‰: `ìˆ˜ì…ì§€ì—­`  
   - ë‹¨ìœ„ê°€ê²©ì´ `0`ì¸ ë°ì´í„°ëŠ” ê·¸ë˜í”„ì—ì„œ ì œì™¸

2. **2ë²ˆ ê·¸ë˜í”„ â€“ ì´ê¸ˆì•¡**
   - ë‹¨ìœ„: ì‚¬ì´ë“œë°”ì—ì„œ `ë°±ë§Œë‹¬ëŸ¬ / ì–µë‹¬ëŸ¬` ì„ íƒ
   - íƒ€ì…:
     - ëˆ„ì  ì˜ì—­ê·¸ë˜í”„: ëŒ€ë¥™ë³„ ê¸ˆì•¡ ê·œëª¨ ì¶”ì´
     - 100% ëˆ„ì ë§‰ëŒ€ê·¸ë˜í”„: ì‹œì ë³„ **ëŒ€ë¥™ ê°„ ê¸ˆì•¡ ë¹„ì¤‘ êµ¬ì¡°** í™•ì¸

3. **3ë²ˆ ê·¸ë˜í”„ â€“ ì¤‘ëŸ‰**
   - ë‹¨ìœ„: ì‚¬ì´ë“œë°”ì—ì„œ `í†¤ / ì²œí†¤` ì„ íƒ
   - íƒ€ì…:
     - ëˆ„ì  ì˜ì—­ê·¸ë˜í”„: ëŒ€ë¥™ë³„ ìˆ˜ì… ì¤‘ëŸ‰ ê·œëª¨ ì¶”ì´
     - 100% ëˆ„ì ë§‰ëŒ€ê·¸ë˜í”„: ì‹œì ë³„ **ëŒ€ë¥™ ê°„ ì¤‘ëŸ‰ ë¹„ì¤‘ êµ¬ì¡°** í™•ì¸

4. **í•˜ë‹¨ í…Œì´ë¸”**
   - ì»¬ëŸ¼ ìˆœì„œ: `ì—°ì›”ì¼, ìˆ˜ì…ì§€ì—­, ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬), ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬), ì¤‘ëŸ‰(í†¤)`
   - í‘œì‹œ í˜•ì‹:
     - `ì—°ì›”ì¼` â†’ `YYYY-MM`
     - `ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)` â†’ ì†Œìˆ˜ì  1ìë¦¬
     - `ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)`, `ì¤‘ëŸ‰(í†¤)` â†’ ë°˜ì˜¬ë¦¼ ì •ìˆ˜ + ì²œë‹¨ìœ„ ì½¤ë§ˆ

---

## 2. í•œêµ­ê°€ìŠ¤ê³µì‚¬_ì›”ë³„ ì‹œë„ë³„ ë„ì‹œê°€ìŠ¤ íŒë§¤í˜„í™© (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì‚¬ìš©)

- ì›ë³¸ ë°ì´í„°: ê³µê³µë°ì´í„°í¬í„¸(data.go.kr)
- ë°ì´í„°ì…‹ ì´ë¦„: **í•œêµ­ê°€ìŠ¤ê³µì‚¬_ì›”ë³„ ì‹œë„ë³„ ë„ì‹œê°€ìŠ¤ íŒë§¤í˜„í™©**
- ë§í¬: https://www.data.go.kr/data/15040819/fileData.do

### (ì˜ˆì‹œ) í™œìš© ë°©ì‹ ê°œìš”

ì´ ë°ì´í„°ì…‹ì€ ë³„ë„ì˜ Streamlit í˜ì´ì§€ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì£¼ìš” ì›ë³¸ ì»¬ëŸ¼ ì˜ˆì‹œ
  - `ì—°ì›”`
  - `ê°•ì›`, `ì„œìš¸`, `ê²½ê¸°`, `ì¸ì²œ`, `ê²½ë‚¨`, `ê²½ë¶`, `ê´‘ì£¼`, `ëŒ€êµ¬`, `ëŒ€ì „`,
    `ë¶€ì‚°`, `ì„¸ì¢…`, `ìš¸ì‚°`, `ì „ë‚¨`, `ì „ë¶`, `ì œì£¼`, `ì¶©ë‚¨`, `ì¶©ë¶` ë“± ì‹œë„ë³„ íŒë§¤ëŸ‰
- ì „ì²˜ë¦¬ ì˜ˆì‹œ
  1. `ì—°ì›”`ì„ ë‚ ì§œ ë˜ëŠ” ë¬¸ìì—´(YYYY-MM)ë¡œ ë³€í™˜
  2. `pd.melt`ë¥¼ ì‚¬ìš©í•˜ì—¬  
     `ì—°ì›”, ì‹œë„, íŒë§¤ëŸ‰` êµ¬ì¡°ì˜ long í¬ë§·ìœ¼ë¡œ ë³€í™˜
  3. í•„ìš” ì‹œ ë‹¨ìœ„ë¥¼ ë³€í™˜í•˜ê±°ë‚˜(ì˜ˆ: ì²œ ë‹¨ìœ„, ë°±ë§Œ ë‹¨ìœ„), ì‹œë„/ì—°ë„ë³„ ì§‘ê³„ ìƒì„±
- ì‹œê°í™” ì˜ˆì‹œ
  - ì‹œë„ë³„ ì›”ê°„ íŒë§¤ëŸ‰ ì¶”ì„¸ êº¾ì€ì„  ê·¸ë˜í”„
  - íŠ¹ì • ì—°ë„ ê¸°ì¤€ ì‹œë„ë³„ ë§‰ëŒ€ê·¸ë˜í”„
  - ëˆ„ì /ë¹„ì¤‘ ê·¸ë˜í”„ ë“±

ì´ í˜ì´ì§€(`ëŒ€ë¥™ë³„_ì²œì—°ê°€ìŠ¤_ìˆ˜ì…í˜„í™©.py`)ì—ì„œëŠ” **ëŒ€ë¥™ë³„ ìˆ˜ì… ë°ì´í„°ë§Œ ì‚¬ìš©**í•˜ë©°,  
ì‹œë„ë³„ íŒë§¤í˜„í™© ë°ì´í„°ëŠ” ë‹¤ë¥¸ ë¶„ì„/ì‹œê°í™” í˜ì´ì§€ì—ì„œ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"""

from pathlib import Path

import pandas as pd
import plotly.express as px
import streamlit as st

# ======================
# ê¸°ë³¸ ì„¤ì •
# ======================
st.set_page_config(page_title="ëŒ€ë¥™ë³„ ì²œì—°ê°€ìŠ¤ ìˆ˜ì… í˜„í™©", layout="wide")
st.title("ğŸŒ í•œêµ­ì˜ ëŒ€ë¥™ë³„ ì²œì—°ê°€ìŠ¤ ìˆ˜ì… í˜„í™© ë¶„ì„")

# ---- ìƒëŒ€ê²½ë¡œë¡œ ìˆ˜ì • ----
# (ì´ íŒŒì¼ì˜ ìƒìœ„ í´ë” â†’ /data ë””ë ‰í† ë¦¬)
REPO_ROOT = Path(__file__).resolve().parents[1]
DATA_PATH = REPO_ROOT / "data" / "í•œêµ­ê°€ìŠ¤ê³µì‚¬_í•œêµ­ì˜ ëŒ€ë¥™ë³„ ì²œì—°ê°€ìŠ¤ ìˆ˜ì… í˜„í™©_20240630.csv"

FILE_PATH = DATA_PATH

# ======================
# ë°ì´í„° ë¡œë“œ & ì •ê·œí™”
# ======================
@st.cache_data
def load_and_transform(path: Path) -> pd.DataFrame:
    # CSV ì½ê¸° (ì¸ì½”ë”© ìë™)
    try:
        df = pd.read_csv(path, encoding="utf-8")
    except UnicodeDecodeError:
        df = pd.read_csv(path, encoding="cp949")

    # 1) ì˜ëª»ëœ ì»¬ëŸ¼ëª… ë³´ì •: "ì¤‘ëŸ‰(í†¤)ê¸°íƒ€" -> "ì¤‘ëŸ‰(í†¤)_ê¸°íƒ€"
    if "ì¤‘ëŸ‰(í†¤)ê¸°íƒ€" in df.columns:
        df = df.rename(columns={"ì¤‘ëŸ‰(í†¤)ê¸°íƒ€": "ì¤‘ëŸ‰(í†¤)_ê¸°íƒ€"})

    # 2) í•©ê³„ ì—´ ì™„ì „íˆ ì œê±°
    #    ex) ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)_í•©ê³„, ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)_í•©ê³„, ì¤‘ëŸ‰(í†¤)_í•©ê³„
    df = df.drop(columns=[c for c in df.columns if c.endswith("_í•©ê³„")])

    # 3) ì§€í‘œë³„ ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸
    price_cols = [c for c in df.columns if "ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)" in c]
    money_cols = [c for c in df.columns if "ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)" in c]
    weight_cols = [c for c in df.columns if "ì¤‘ëŸ‰(í†¤)" in c]

    # 4) melt: ë‹¨ìœ„ê°€ê²©
    df_price = df.melt(
        id_vars=["ì—°ì›”ì¼"],
        value_vars=price_cols,
        var_name="tmp",
        value_name="ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)",
    )
    df_price["ìˆ˜ì…ì§€ì—­"] = df_price["tmp"].str.replace(
        r"ë‹¨ìœ„ê°€ê²©\(í†¤ë‹¹ë‹¬ëŸ¬\)_", "", regex=True
    )
    df_price = df_price.drop(columns=["tmp"])

    # 5) melt: ê¸ˆì•¡
    df_money = df.melt(
        id_vars=["ì—°ì›”ì¼"],
        value_vars=money_cols,
        var_name="tmp",
        value_name="ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)",
    )
    df_money["ìˆ˜ì…ì§€ì—­"] = df_money["tmp"].str.replace(
        r"ê¸ˆì•¡\(ë°±ë§Œë‹¬ëŸ¬\)_", "", regex=True
    )
    df_money = df_money.drop(columns=["tmp"])

    # 6) melt: ì¤‘ëŸ‰
    df_weight = df.melt(
        id_vars=["ì—°ì›”ì¼"],
        value_vars=weight_cols,
        var_name="tmp",
        value_name="ì¤‘ëŸ‰(í†¤)",
    )
    df_weight["ìˆ˜ì…ì§€ì—­"] = df_weight["tmp"].str.replace(
        r"ì¤‘ëŸ‰\(í†¤\)_", "", regex=True
    )
    df_weight = df_weight.drop(columns=["tmp"])

    # 7) ë³‘í•© â†’ ìµœì¢… long ë°ì´í„°
    df_long = (
        df_price
        .merge(df_money, on=["ì—°ì›”ì¼", "ìˆ˜ì…ì§€ì—­"])
        .merge(df_weight, on=["ì—°ì›”ì¼", "ìˆ˜ì…ì§€ì—­"])
    )

    # 8) ë‚ ì§œ í˜•ì‹ ë³€í™˜ (Timestamp)
    df_long["ì—°ì›”ì¼"] = pd.to_datetime(df_long["ì—°ì›”ì¼"])

    # ì •ë ¬
    df_long = df_long.sort_values(["ì—°ì›”ì¼", "ìˆ˜ì…ì§€ì—­"]).reset_index(drop=True)

    return df_long


df = load_and_transform(FILE_PATH)

# ======================
# ì‚¬ì´ë“œë°” í•„í„°
# ======================
st.sidebar.header("âš™ï¸ í•„í„°")

# ìˆ˜ì…ì§€ì—­ ì„ íƒ
regions = sorted(df["ìˆ˜ì…ì§€ì—­"].unique())
selected_regions = st.sidebar.multiselect(
    "ìˆ˜ì…ì§€ì—­ ì„ íƒ",
    options=regions,
    default=regions,
)

# --- ë‚ ì§œ ìŠ¬ë¼ì´ë” (date íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•´ì„œ ì‚¬ìš©) ---
date_min_ts = df["ì—°ì›”ì¼"].min()
date_max_ts = df["ì—°ì›”ì¼"].max()

date_min = date_min_ts.date()
date_max = date_max_ts.date()

date_range = st.sidebar.slider(
    "ê¸°ê°„ ì„ íƒ",
    min_value=date_min,
    max_value=date_max,
    value=(date_min, date_max),
    format="YYYY-MM-DD",
)
start_date, end_date = date_range

# ì´ê¸ˆì•¡ ë‹¨ìœ„ ì„ íƒ
amount_unit = st.sidebar.radio(
    "ì´ê¸ˆì•¡ ë‹¨ìœ„",
    ["ë°±ë§Œë‹¬ëŸ¬", "ì–µë‹¬ëŸ¬"],
    horizontal=True,
)

# ì¤‘ëŸ‰ ë‹¨ìœ„ ì„ íƒ
weight_unit = st.sidebar.radio(
    "ì¤‘ëŸ‰ ë‹¨ìœ„",
    ["í†¤", "ì²œí†¤"],
    horizontal=True,
)

# 2Â·3ë²ˆ ê·¸ë˜í”„ íƒ€ì… ì„ íƒ (ê³µí†µ)
chart_type = st.sidebar.radio(
    "2Â·3ë²ˆ ê·¸ë˜í”„ íƒ€ì…",
    ["ëˆ„ì  ì˜ì—­ê·¸ë˜í”„", "100% ëˆ„ì ë§‰ëŒ€ê·¸ë˜í”„(ë¹„ìœ¨)"],
)

# ======================
# í•„í„° ì ìš©
# ======================
mask = (
    df["ìˆ˜ì…ì§€ì—­"].isin(selected_regions)
    & (df["ì—°ì›”ì¼"].dt.date >= start_date)
    & (df["ì—°ì›”ì¼"].dt.date <= end_date)
)
df_filtered = df[mask].copy()

# ======================
# ë‹¨ìœ„ ë³€í™˜ í•¨ìˆ˜ë“¤
# ======================
def convert_amount(df_in: pd.DataFrame, unit: str):
    df_out = df_in.copy()
    if unit == "ë°±ë§Œë‹¬ëŸ¬":
        factor = 1
        y_label = "ê¸ˆì•¡ (ë°±ë§Œë‹¬ëŸ¬)"
    elif unit == "ì–µë‹¬ëŸ¬":
        # 1ì–µë‹¬ëŸ¬ = 100ë°±ë§Œë‹¬ëŸ¬ â†’ ì–µë‹¬ëŸ¬ = ë°±ë§Œë‹¬ëŸ¬ / 100
        factor = 1 / 100
        y_label = "ê¸ˆì•¡ (ì–µë‹¬ëŸ¬)"
    else:
        factor = 1
        y_label = "ê¸ˆì•¡ (ë°±ë§Œë‹¬ëŸ¬)"

    df_out["ê¸ˆì•¡_ë³€í™˜"] = df_out["ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)"] * factor
    return df_out, y_label


def convert_weight(df_in: pd.DataFrame, unit: str):
    df_out = df_in.copy()
    if unit == "í†¤":
        factor = 1
        y_label = "ì¤‘ëŸ‰ (í†¤)"
    elif unit == "ì²œí†¤":
        factor = 1 / 1000
        y_label = "ì¤‘ëŸ‰ (ì²œí†¤)"
    else:
        factor = 1
        y_label = "ì¤‘ëŸ‰ (í†¤)"

    df_out["ì¤‘ëŸ‰_ë³€í™˜"] = df_out["ì¤‘ëŸ‰(í†¤)"] * factor
    return df_out, y_label


df_amount, amount_y_label = convert_amount(df_filtered, amount_unit)
df_weight, weight_y_label = convert_weight(df_filtered, weight_unit)

# ======================
# 1ë²ˆ ê·¸ë˜í”„: ë‹¨ìœ„ê¸ˆì•¡ êº¾ì€ì„  ê·¸ë˜í”„ (ë‹¨ìœ„ê°€ê²© 0 ì œì™¸)
# ======================
st.subheader("1ï¸âƒ£ ë‹¨ìœ„ê¸ˆì•¡ ì¶”ì´ â€” ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬) êº¾ì€ì„  ê·¸ë˜í”„")

# ë‹¨ìœ„ê°€ê²© 0ì¸ ê°’ì€ ê·¸ë˜í”„ì—ì„œ ì œì™¸
df_line = df_filtered[df_filtered["ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)"] != 0].copy()

if df_line.empty:
    st.warning("ë‹¨ìœ„ê°€ê²©ì´ 0ì´ ì•„ë‹Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.")
else:
    fig1 = px.line(
        df_line.sort_values("ì—°ì›”ì¼"),
        x="ì—°ì›”ì¼",
        y="ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)",
        color="ìˆ˜ì…ì§€ì—­",
        markers=True,
        title="ëŒ€ë¥™ë³„ ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬) ì¶”ì´ (ë‹¨ìœ„ê°€ê²© 0 ì œì™¸)",
    )
    fig1.update_layout(
        xaxis_title="ì—°ì›”ì¼",
        yaxis_title="ë‹¨ìœ„ê°€ê²© (í†¤ë‹¹ë‹¬ëŸ¬)",
        hovermode="x unified",
    )
    st.plotly_chart(fig1, use_container_width=True)

# ======================
# 2ë²ˆ ê·¸ë˜í”„: ì´ê¸ˆì•¡ ëˆ„ì  ì˜ì—­ / 100% ëˆ„ì ë§‰ëŒ€
# ======================
st.subheader("2ï¸âƒ£ ì´ê¸ˆì•¡ â€” ëˆ„ì  ì˜ì—­ê·¸ë˜í”„ / 100% ëˆ„ì ë§‰ëŒ€ê·¸ë˜í”„")

if df_amount.empty:
    st.warning("ì„ íƒëœ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    if chart_type == "ëˆ„ì  ì˜ì—­ê·¸ë˜í”„":
        # ---- ëˆ„ì  ì˜ì—­ê·¸ë˜í”„ (ê¸ˆì•¡) ----
        df_plot_amt = df_amount.sort_values("ì—°ì›”ì¼").copy()
        fig2 = px.area(
            df_plot_amt,
            x="ì—°ì›”ì¼",
            y="ê¸ˆì•¡_ë³€í™˜",
            color="ìˆ˜ì…ì§€ì—­",
            title=f"ëŒ€ë¥™ë³„ {amount_y_label} ì¶”ì´ (ëˆ„ì  ì˜ì—­)",
        )
        fig2.update_layout(
            xaxis_title="ì—°ì›”ì¼",
            yaxis_title=amount_y_label,
            hovermode="x unified",
        )
        st.plotly_chart(fig2, use_container_width=True)

    else:
        # ---- 100% ëˆ„ì ë§‰ëŒ€ê·¸ë˜í”„ (ê¸ˆì•¡ ë¹„ì¤‘) ----
        df_pct_amt = df_amount.sort_values("ì—°ì›”ì¼").copy()
        total_by_date_amt = df_pct_amt.groupby("ì—°ì›”ì¼")["ê¸ˆì•¡_ë³€í™˜"].transform("sum")
        df_pct_amt["ë¹„ì¤‘(%)"] = df_pct_amt["ê¸ˆì•¡_ë³€í™˜"] / total_by_date_amt * 100

        fig2 = px.bar(
            df_pct_amt,
            x="ì—°ì›”ì¼",
            y="ë¹„ì¤‘(%)",
            color="ìˆ˜ì…ì§€ì—­",
            title=f"ëŒ€ë¥™ë³„ ê¸ˆì•¡ ë¹„ì¤‘ (100% ëˆ„ì ë§‰ëŒ€, ê¸°ì¤€: {amount_unit})",
        )
        fig2.update_layout(
            xaxis_title="ì—°ì›”ì¼",
            yaxis_title="ë¹„ì¤‘ (%)",
            barmode="stack",
            hovermode="x unified",
        )
        st.plotly_chart(fig2, use_container_width=True)

# ======================
# 3ë²ˆ ê·¸ë˜í”„: ì¤‘ëŸ‰ ëˆ„ì  ì˜ì—­ / 100% ëˆ„ì ë§‰ëŒ€
# ======================
st.subheader("3ï¸âƒ£ ì¤‘ëŸ‰ â€” ëˆ„ì  ì˜ì—­ê·¸ë˜í”„ / 100% ëˆ„ì ë§‰ëŒ€ê·¸ë˜í”„")

if df_weight.empty:
    st.warning("ì„ íƒëœ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    if chart_type == "ëˆ„ì  ì˜ì—­ê·¸ë˜í”„":
        # ---- ëˆ„ì  ì˜ì—­ê·¸ë˜í”„ (ì¤‘ëŸ‰) ----
        df_plot_wgt = df_weight.sort_values("ì—°ì›”ì¼").copy()
        fig3 = px.area(
            df_plot_wgt,
            x="ì—°ì›”ì¼",
            y="ì¤‘ëŸ‰_ë³€í™˜",
            color="ìˆ˜ì…ì§€ì—­",
            title=f"ëŒ€ë¥™ë³„ {weight_y_label} ì¶”ì´ (ëˆ„ì  ì˜ì—­)",
        )
        fig3.update_layout(
            xaxis_title="ì—°ì›”ì¼",
            yaxis_title=weight_y_label,
            hovermode="x unified",
        )
        st.plotly_chart(fig3, use_container_width=True)

    else:
        # ---- 100% ëˆ„ì ë§‰ëŒ€ê·¸ë˜í”„ (ì¤‘ëŸ‰ ë¹„ì¤‘) ----
        df_pct_wgt = df_weight.sort_values("ì—°ì›”ì¼").copy()
        total_by_date_wgt = df_pct_wgt.groupby("ì—°ì›”ì¼")["ì¤‘ëŸ‰_ë³€í™˜"].transform("sum")
        df_pct_wgt["ë¹„ì¤‘(%)"] = df_pct_wgt["ì¤‘ëŸ‰_ë³€í™˜"] / total_by_date_wgt * 100

        fig3 = px.bar(
            df_pct_wgt,
            x="ì—°ì›”ì¼",
            y="ë¹„ì¤‘(%)",
            color="ìˆ˜ì…ì§€ì—­",
            title=f"ëŒ€ë¥™ë³„ ì¤‘ëŸ‰ ë¹„ì¤‘ (100% ëˆ„ì ë§‰ëŒ€, ê¸°ì¤€: {weight_unit})",
        )
        fig3.update_layout(
            xaxis_title="ì—°ì›”ì¼",
            yaxis_title="ë¹„ì¤‘ (%)",
            barmode="stack",
            hovermode="x unified",
        )
        st.plotly_chart(fig3, use_container_width=True)

# ======================
# í•˜ë‹¨: ì‚¬ëŒì´ ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ…ëœ ë°ì´í„° í…Œì´ë¸”
# ======================
st.divider()
st.subheader("ğŸ” í•„í„° ì ìš©ëœ ë°ì´í„° (í¬ë§·íŒ…)")

if df_filtered.empty:
    st.info("í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    df_table = df_filtered.copy()

    # ì—´ ìˆœì„œ ì •ë¦¬
    df_table = df_table[["ì—°ì›”ì¼", "ìˆ˜ì…ì§€ì—­", "ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)", "ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)", "ì¤‘ëŸ‰(í†¤)"]]

    # ì—°ì›”ì¼ â†’ YYYY-MM í˜•ì‹ ë¬¸ìì—´
    df_table["ì—°ì›”ì¼"] = df_table["ì—°ì›”ì¼"].dt.strftime("%Y-%m")

    # ë‹¨ìœ„ê°€ê²©: ì†Œìˆ˜ì  ì²«ì§¸ ìë¦¬ê¹Œì§€
    df_table["ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)"] = df_table["ë‹¨ìœ„ê°€ê²©(í†¤ë‹¹ë‹¬ëŸ¬)"].round(1)

    # ê¸ˆì•¡, ì¤‘ëŸ‰: ì²œë‹¨ìœ„ ì½¤ë§ˆê°€ ë“¤ì–´ê°„ ì •ìˆ˜ í˜•ì‹ ë¬¸ìì—´
    df_table["ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)"] = df_table["ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)"].round(0)
    df_table["ì¤‘ëŸ‰(í†¤)"] = df_table["ì¤‘ëŸ‰(í†¤)"].round(0)

    df_table["ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)"] = df_table["ê¸ˆì•¡(ë°±ë§Œë‹¬ëŸ¬)"].apply(
        lambda v: "" if pd.isna(v) else f"{int(v):,}"
    )
    df_table["ì¤‘ëŸ‰(í†¤)"] = df_table["ì¤‘ëŸ‰(í†¤)"].apply(
        lambda v: "" if pd.isna(v) else f"{int(v):,}"
    )

    st.dataframe(
        df_table,
        use_container_width=True,
        height=450,
    )